<div>
    <div id="{{key}}-container"></div>
    <button type="button" class="dashboard-button dashboard-button-primary-outline" id="add-new-item" class="add-new" data-tag-name="{{key}}" onclick="addItem(this)"><i class="fas fa-plus"></i>&nbsp;Add</button>
    <input id="id-{{key}}" type="hidden" data-output-type="json" name="{{key}}" value=""/>
</div>

<script>

// initialize a unique counter:
let {{key}}_idx = 1;

function addItem(elem) {
    i = {{key}}_idx;
    var tagname = elem.getAttribute('data-tag-name');
    let template = `
        <div class="form-row" id="${tagname}-${i}">
			<div class="form-group" style="margin-right: 8px">
				<label>Target</label>
				<input type="number" class="form-control" name="${tagname}_tmp[][target]" class="form-control" required>
			</div>
			<div class="form-group" style="margin-right: 8px">
				<label>Source</label>
				<input type="number" class="form-control" name="${tagname}_tmp[][source]" class="form-control" required>
			</div>
			<div class="form-group" style="margin-right: 8px">
				<label>Endpoint</label>
				<input type="text" class="form-control" name="${tagname}_tmp[][endpoint]" class="form-control" required>
			</div>
			<div class="form-group">
				<label style="visibility: hidden;display: block;">Remove</label>
				<button type=button class='dashboard-button dashboard-button-danger-outline' href="" onclick="javascript:removeItem('${tagname}'+ '-' + ${i} + '' ); return false;"><i class="fas fa-trash-alt"></i>&nbsp;Remove</button>
			</div>
        </div>`;

    let container = document.getElementById(tagname + '-container');
    let div = document.createElement('div');
    div.innerHTML = template;
    container.appendChild(div);

    i++;
    {{key}}_idx = i;
}

function removeItem(elementId) {
    var element = document.getElementById(elementId);
    console.log("id: " + elementId)
    console.log(element)
    element.parentNode.removeChild(element);
}

/* MANAGE DEFAULTS */
$(document).ready(() => {
    const value = {{ value | tojson }};

    const btn = $('#add-new-item');
    const tagname = btn.attr('data-tag-name');

    // Iterate through the default list
    value.default.forEach((item, index) => {
        // Click button to create a new entry
        btn.click();

        // Get the corresponding input fields for this index
        const targetField = document.getElementsByName(`${tagname}_tmp[][target]`)[index];
        const sourceField = document.getElementsByName(`${tagname}_tmp[][source]`)[index];
        const endpointField = document.getElementsByName(`${tagname}_tmp[][endpoint]`)[index];

        // Fill only the fields that exist in this item
        if (item.target !== undefined && targetField) targetField.value = item.target;
        if (item.source !== undefined && sourceField) sourceField.value = item.source;
        if (item.endpoint !== undefined && endpointField) endpointField.value = item.endpoint;
    });
});

</script>

<style>

label {
	margin-bottom: 0;
	margin-left: 5px;
}

</style>